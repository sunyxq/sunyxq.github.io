# 发布订阅模式

前端中使用**发布订阅模式**主要用于模块间或页面(组件)间进行数据通信。

## Vue 中使用 EventBus 进行数据通信

**main.js**

```js
Vue.prototype.$bus = new Vue();
```

**ShowMsg.vue**

```js
export default {
  name: "show-msg",
  create() {
    this.$bus.$on("log:msg", (msg) => {
      console.log(msg);
    });
  },
  beforeDestroy() {
    this.$bus.$off("log:msg");
  },
};
```

**SendMsg.vue**

```js
export default {
  name: "send-msg",
  data() {
    return {
      message: "Hello, Vue!",
    };
  },
  methods: {
    sendMessage() {
      this.$bus.$emit("log:msg", this.message);
    },
  },
};
```

## Nodejs 中使用`events`模块

```js
const EventEmitter = require("events");

class MyEmitter extends EventEmitter {}

const myEmitter = new MyEmitter();
myEmitter.on("event", (msg) => {
  console.log("event log:", msg);
});
myEmitter.emit("event", "Hello Node!");
```

## 发布订阅模式实战

```ts
type EventHandler = (...args: any[]) => any;

class EventEmitter {
  private events = new Map<string, EventHandler[]>();

  // 订阅主题
  subscribe(topic: string, ...handlers: EventHandler[]): void {
    let topics = this.events.get(topic);
    if (!topics) {
      this.events.set(topic, (topics = []));
    }
    topics.push(...handlers);
  }

  // 取消订阅主题
  unsubscribe(topic: string, handler?: EventHandler): boolean {
    if (!handler) {
      // 没有处理函数时，直接删除topic对应的回调函数
      return this.events.delete(topic);
    }
    const handlers = this.events.get(topic);
    if (!handlers) {
      // topic对应的回调函数没有时，直接返回
      return false;
    }
    const curIdx = handlers.indexOf(handler); // 当前回调函数索引
    if (curIdx < 0) {
      // 没有包含当前处理函数时
      return false;
    }
    handlers.splice(curIdx, 1); // 删除当前回调函数
    if (handlers.length === 0) {
      // 剩余处理函数没有时，删除当前topic
      this.events.delete(topic);
    }
    return true;
  }

  // 触发主题消息
  publish(topic: string, ...args: any[]): any[] | null {
    const handlers = this.events.get(topic);
    if (!handlers) {
      return null;
    }
    return handlers.map((handler) => {
      try {
        handler(...args);
      } catch (err) {
        console.error(err);
        return null;
      }
    });
  }
}
```
